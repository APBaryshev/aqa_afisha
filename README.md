# Автотесты для Яндекс.Афиша

Проект автоматизированного тестирования веб-приложения Яндекс.Афиша с использованием Typescript, Playwright и Allure Report.

## Архитектура проекта

Процесс тестирования был построен на основе методического подхода с использованием [Mind Map](aqa_afisha.pdf):

### Планирование тестирования

Перед написанием кода была создана [Mind Map](aqa_afisha.pdf), которая послужила основой для:

- Анализа функциональности - полный охват элементов главной страницы Яндекс.Афиши
- Определения тестовых сценариев - выделение критических пользовательских путей
- Структурирования тестов - логическое разделение на модули и компоненты
- Приоритизации проверок - выделение наиболее важных функциональных блоков

### Итеративный процесс разработки

По мере реализации автотестов [Mind Map](aqa_afisha.pdf) использовалась как:

1. Чек-лист покрытия - отмечались реализованные тестовые сценарии
2. Визуальный трекер прогресса - отслеживание завершенности каждого модуля
3. Инструмент коммуникации - четкое представление о покрытии функциональности
4. Основа для документации - структура README и организации кода

### Реализованные модули

На [Mind Map](aqa_afisha.pdf) были выделены и успешно покрыты автотестами:

- **Навигационная система** - табы, выпадающие меню, hover-эффекты
- **Интерактивные элементы** - календарь, баннеры, карусели
- **Контентные блоки** - события, ТОП-10, основная лента
- **Пользовательские сценарии** - история просмотров, взаимодействие с карточками

### Результат подхода

Использование [Mind Map](aqa_afisha.pdf) позволило:

- Обеспечить полное покрытие функциональности  
- Создать логичную структуру тестовых сценариев  
- Избежать пропуска критических сценариев  
- Ускорить процесс разработки за счет четкого плана  
- Облегчить поддержку и расширение тестовой базы  

[Mind Map](aqa_afisha.pdf) стала не просто диаграммой, а рабочим инструментом, который направлял весь процесс разработки автотестов от планирования до реализации.

---

## Быстрый старт (рекомендуется)

### Для Windows

```bash
# Скачайте проект и выполните:
cd scripts
start.bat
```

После завершения тестов в консоли появится сообщение с командой для открытия отчета.

### Для Mac/Linux

```bash
# Скачайте проект и выполните:
cd scripts
chmod +x start.sh
./start.sh
```

После завершения тестов в консоли появится сообщение с командой для открытия отчета.

Что произойдет автоматически:

- Проверит установку Node.js и Docker
- Установит все зависимости проекта
- Запустит все автотесты в Docker
- Покажет команду для открытия Allure отчета

---

## Содержание

- [Автотесты для Яндекс.Афиша](#автотесты-для-яндексафиша)
  - [Архитектура проекта](#архитектура-проекта)
    - [Планирование тестирования](#планирование-тестирования)
    - [Итеративный процесс разработки](#итеративный-процесс-разработки)
    - [Реализованные модули](#реализованные-модули)
    - [Результат подхода](#результат-подхода)
  - [Быстрый старт (рекомендуется)](#быстрый-старт-рекомендуется)
    - [Для Windows](#для-windows)
    - [Для Mac/Linux](#для-maclinux)
  - [Содержание](#содержание)
  - [Технологии](#технологии)
  - [Что тестируется](#что-тестируется)
  - [Структура проекта](#структура-проекта)
  - [Скрипты проекта](#скрипты-проекта)
    - [Основные скрипты](#основные-скрипты)
    - [NPM скрипты (package.json)](#npm-скрипты-packagejson)
    - [Процесс работы](#процесс-работы)
  - [Запуск тестов](#запуск-тестов)
    - [Запуск всех тестов](#запуск-всех-тестов)
    - [Запуск с генерацией Allure отчетов](#запуск-с-генерацией-allure-отчетов)
    - [Запуск конкретного теста](#запуск-конкретного-теста)
    - [Запуск тестов в headed режиме (с браузером)](#запуск-тестов-в-headed-режиме-с-браузером)
    - [Запуск в Docker](#запуск-в-docker)
  - [Генерация отчетов](#генерация-отчетов)
  - [Просмотр отчетов](#просмотр-отчетов)
  - [Работа с Docker](#работа-с-docker)
  - [Ручная установка](#ручная-установка)
  - [Работа с CAPTCHA](#работа-с-captcha)
    - [Признаки появления CAPTCHA](#признаки-появления-captcha)
    - [Алгоритм решения](#алгоритм-решения)
    - [Что происходит под капотом](#что-происходит-под-капотом)
    - [Файлы системы](#файлы-системы)

## Технологии

- **TypeScript** - язык программирования
- **Playwright** - фреймворк для автоматизации тестирования
- **Allure Report** - система отчетов
- **Docker** - контейнеризация
- **Page Object Model** - паттерн проектирования

## Что тестируется

- Навигационные табы - видимость, иконки, hover-эффекты
- Календарь событий - отображение, прокрутка, доступные даты
- Баннеры - отображение, прокрутка карусели
- Блок "События в ближайшие дни" - карточки, элементы, hover-эффекты
- Раздел "ТОП-10" - карточки, элементы, горизонтальная прокрутка
- Основная лента событий - карточки, история просмотров

## Структура проекта

```text
aqa_afisha/
├── scripts/                    # Скрипты автоматического запуска
│   ├── start.sh                # Основной скрипт (Mac/Linux)
│   ├── start.bat               # Основной скрипт (Windows)  
│   ├── open-report.sh          # Скрипт открытия отчета (Mac/Linux)
│   └── open-report.bat         # Скрипт открытия отчета (Windows)
├── src/
│   ├── locators/               # Локаторы элементов
│   │   └── MainPageLocators.ts
│   └── pages/                  # Page Objects
│       ├── BasePage.ts
│       ├── MainPage.ts
│       ├── Navigation.ts
│       ├── Calendar.ts
│       ├── Banners.ts
│       ├── Events.ts
│       ├── TopSection.ts
│       └── MainFeed.ts
├── tests/                      # Тестовые спецификации
│   ├── test_nav_tabs.spec.ts
│   ├── test_calendar.spec.ts
│   ├── test_events.spec.ts
│   ├── test_top_section.spec.ts
│   ├── test_main_feed.spec.ts
│   └── test_banners.spec.ts
├── allure-results/             # Результаты для Allure (автосоздается)
├── test-results/               # Результаты тестов (автосоздается)
├── aqa_afisha.pdf              # Mind Map архитектуры
├── Dockerfile
├── playwright.config.ts
└── package.json
```

---

## Скрипты проекта

### Основные скрипты

- `start.sh` / `start.bat` - полная установка и запуск тестов
- `open-report.sh` / `open-report.bat` - открытие отчета после тестов

### NPM скрипты (package.json)

- `npm start` - полный цикл тестирования
- `npm test` - запуск тестов локально
- `npm run docker:full` - тесты в Docker с отчетом
- `npm run docker:test` - только тесты в Docker
- `npm run allure:serve` - открытие Allure отчета

### Процесс работы

1. Запустите `start.sh` или `start.bat`
2. Дождитесь завершения тестов
3. Выполните команду из сообщения для открытия отчета
4. Изучите результаты в браузере

---

## Запуск тестов

### Запуск всех тестов

```bash
npm test
```

### Запуск с генерацией Allure отчетов

```bash
npm run test:report
```

### Запуск конкретного теста

```bash
npx playwright test tests/test_nav_tabs.spec.ts
```

### Запуск тестов в headed режиме (с браузером)

```bash
npx playwright test --headed
```

### Запуск в Docker

```bash
# Собрать образ и запустить тесты
npm run docker:full

# Или по шагам
npm run docker:build
npm run docker:test
```

---

## Генерация отчетов

Установка Allure

```bash
# Через npm (рекомендуется)
npm install -g allure-commandline

# Альтернативные способы:
# Windows: scoop install allure
# macOS: brew install allure  
# Linux: sdk install allure
```

## Просмотр отчетов

```bash
# Сгенерировать и открыть отчет
npm run test:report

# Только открыть последние результаты
npm run allure:serve

# Генерация HTML отчета
npm run allure:generate

# Открыть сгенерированный отчет
npm run allure:open
```

---

## Работа с Docker

```bash
# Полный цикл в Docker (сборка + тесты + отчет)
npm run docker:full

# Только сборка образа
npm run docker:build

# Только запуск тестов в Docker (требует собранный образ)
npm run docker:test

# Тесты + открытие отчета
npm run docker:report
```

>Примечание: При первом запуске или после изменений в коде необходимо выполнить `docker:build` или `docker:full` для сборки образа.

---

## Ручная установка

Если автоматические скрипты не работают:

1. Установите Node.js 16+ с официального сайта  

2. Установите Docker Desktop с официального сайта  

3. Клонируйте репозиторий

    ```bash
    git clone <url-репозитория>
    cd aqa_afisha
    ```

4. Установите зависимости

    ```bash
    npm install
    npx playwright install
    ```

5. Запустите тесты

    ```bash
    npm run docker:full
    ```

## Работа с CAPTCHA

Яндекс иногда показывает CAPTCHA при автоматизированных запросах. Для решения этой проблемы реализована система сохранения состояния аутентификации.

### Признаки появления CAPTCHA

- Тесты падают с таймаутами
- В логах виден редирект на `passport.yandex.ru`
- В браузере появляется страница с проверкой "Я не робот"

### Алгоритм решения

**1. Первоначальная настройка (при первом запуске или после очистки):**  

```bash
npm run captcha:setup
```

**2. Если CAPTCHA появилась снова (обычно через несколько дней):**  

```bash
npm run captcha:refresh
```

**3. После этого необходимо запустить тесты как обычно:**  

```bash
npm test
или
npx playwright test
```

### Что происходит под капотом

1. captcha:setup - открывает браузер, нужно вручную пройти CAPTCHA, состояние сохраняется в src/captcha-state.json  

2. Последующие тесты - используют сохраненные cookies для обхода CAPTCHA  

3. captcha:refresh - удаляет устаревшее состояние и создает новое  

### Файлы системы

- scripts/setup-captcha.ts - скрипт для сохранения состояния

- src/captcha-state.json - файл с сохраненной сессией (не коммитить если содержит персональные данные!)

>Примечание:
>Система надежно работает в течение нескольких дней. При появлении CAPTCHA необходимо обновить состояние через captcha:refresh.
